<div class="must-change-container">
  <mat-card class="must-change-card">
    <mat-card-header>
      <div class="header-content">
        <div class="header-icon-wrap">
          <mat-icon class="lock-icon">lock_reset</mat-icon>
        </div>
        <mat-card-title>Password Change Required</mat-card-title>
        <mat-card-subtitle>
          For your security, you must set a new password before continuing.
        </mat-card-subtitle>
      </div>
    </mat-card-header>

    <mat-card-content>
      <form #passwordFormRef="ngForm" (ngSubmit)="onSubmit(passwordFormRef)" novalidate>

        <!-- Current Password -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Current Password</mat-label>
          <mat-icon matPrefix>lock</mat-icon>
          <input matInput
            [type]="showCurrentPassword ? 'text' : 'password'"
            name="currentPassword"
            [sameAs]="'newPassword'"
            [(ngModel)]="passwordForm.currentPassword"
            (ngModelChange)="onCurrentPasswordChange()"
            required
            #currentPwd="ngModel"/>
          <button mat-icon-button matSuffix type="button"
            (click)="showCurrentPassword = !showCurrentPassword">
            <mat-icon>{{ showCurrentPassword ? 'visibility_off' : 'visibility' }}</mat-icon>
          </button>
          <mat-error *ngIf="currentPwd.errors?.['required'] && currentPwd.touched">
            Current password is required.
          </mat-error>
          <mat-error *ngIf="currentPwd.errors?.['sameAs'] && currentPwd.touched">
            Current password must differ from the new one.
          </mat-error>
        </mat-form-field>

        <!-- New Password -->
        <div class="password-group">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>New Password</mat-label>
            <mat-icon matPrefix>lock_open</mat-icon>
            <input matInput
              [type]="showNewPassword ? 'text' : 'password'"
              name="newPassword"
              [(ngModel)]="passwordForm.newPassword"
              (ngModelChange)="onPasswordChange()"
              required
              minlength="8"
              [notSameAs]="'currentPassword'"
              #newPwd="ngModel"/>
            <button mat-icon-button matSuffix type="button"
              (click)="showNewPassword = !showNewPassword">
              <mat-icon>{{ showNewPassword ? 'visibility_off' : 'visibility' }}</mat-icon>
            </button>
            <mat-error *ngIf="newPwd.errors?.['required'] && newPwd.touched">
              New password is required.
            </mat-error>
            <mat-error *ngIf="newPwd.errors?.['minlength'] && newPwd.touched">
              Minimum 8 characters.
            </mat-error>
            <mat-error *ngIf="newPwd.errors?.['notSameAs'] && newPwd.touched">
              New password must differ from the current one.
            </mat-error>
          </mat-form-field>

          <!-- Password Meter -->
          <div class="password-meter" *ngIf="passwordForm.newPassword">
            <div class="password-meter__bars">
              <div class="bar"
                *ngFor="let bar of [1,2,3,4]"
                [class.bar--filled]="getScore() >= bar"
                [ngClass]="getStrengthClass()">
              </div>
            </div>
            <span class="password-meter__label" [ngClass]="getStrengthClass()">
              {{ getStrengthLabel() }}
            </span>
          </div>

          <!-- Password Errors -->
          <div class="password-errors" *ngIf="passwordErrors.length > 0 && passwordForm.newPassword">
            <span *ngFor="let error of passwordErrors" class="password-error">
              <mat-icon>error_outline</mat-icon>{{ error }}
            </span>
          </div>

          <!-- Generate Button -->
          <button mat-stroked-button type="button" (click)="generatePassword()">
            <mat-icon>auto_fix_high</mat-icon>
            Generate Password
          </button>
        </div>

        <div class="actions">
          <button mat-stroked-button type="button" class="logout-btn" (click)="logout()">
            <mat-icon>logout</mat-icon> Logout
          </button>
          <button mat-flat-button type="submit" class="submit-btn"
            [disabled]="passwordFormRef.invalid || isLoading">
            <mat-progress-spinner *ngIf="isLoading" diameter="18" mode="indeterminate"/>
            <span *ngIf="!isLoading">Change Password</span>
          </button>
        </div>

      </form>
    </mat-card-content>
  </mat-card>
</div>
